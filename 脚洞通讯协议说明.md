# 通讯协议说明文档

## 1. 概述

本文档描述了总控与脚洞控制器之间的通讯协议。协议采用485通信，使用特定的数据包格式进行数据传输。
暂定两个脚洞控制盒对8个脚洞进行控制，通讯地址分别为`0x81`和`0x82`。
0x81对应脚洞控制盒1，0x82对应脚洞控制盒2。
定义：现在面向一位端，脚洞控制盒1控制左侧4个脚洞，脚洞控制盒2控制右侧4个脚洞。
0x81和0x82各控制4个脚洞

示例：
主控查询0x81的脚洞1状态：
主控向脚洞控制盒发送数据：7B 7B 09 81 03 03 00 00 00 D1 59 7D 7D 
控制盒返回数据：7B 7B 09 81 06 03 00 00 00 A1 2C 7D 7D（假设当前脚洞1处于收到数据正在开门状态）
控制盒返回数据：7B 7B 09 81 06 03 00 00 A1 00 2C 7D 7D（假设当前脚洞1处于开门完成状态）
控制盒返回数据：7B 7B 09 81 06 03 00 A1 00 00 2C 7D 7D（假设当前脚洞1处于开门故障状态）

主控查询0x82的脚洞1状态:
主控向脚洞控制盒发送数据：7B 7B 09 82 03 03 00 00 00 D1 5A 7D 7D
控制盒返回数据：7B 7B 09 82 06 03 00 00 00 A1 2F 7D 7D（假设当前脚洞1处于收到数据正在开门状态）
控制盒返回数据：7B 7B 09 82 06 03 00 00 A1 00 2F 7D 7D（假设当前脚洞1处于开门完成状态）
控制盒返回数据：7B 7B 09 82 06 03 00 A1 00 00 2F 7D 7D（假设当前脚洞1处于开门故障状态）


主控实际查询发送数据
[16:06:51.326]收←◆7B 7B 09 82 03 05 00 00 00 D1 5C 7D 7D 
[16:06:51.476]收←◆7B 7B 09 82 03 05 00 00 00 D2 5F 7D 7D 
[16:06:51.626]收←◆7B 7B 09 82 03 05 00 00 00 D3 5E 7D 7D 
[16:06:51.776]收←◆7B 7B 09 82 03 05 00 00 00 D4 59 7D 7D 
[16:06:51.926]收←◆7B 7B 09 81 03 05 00 00 00 D1 5F 7D 7D 
[16:06:52.076]收←◆7B 7B 09 81 03 05 00 00 00 D2 5C 7D 7D 
[16:06:52.227]收←◆7B 7B 09 81 03 05 00 00 00 D3 5D 7D 7D 
[16:06:52.376]收←◆7B 7B 09 81 03 05 00 00 00 D4 5A 7D 7D 

## 2. 通信参数

- **通信方式**: 485通信
- **波特率**: 9600bps

## 3. 数据包格式

### 3.1 数据包结构

```
+--------+-----------+------+------+------+------------+------+------+-----------+
| 描述域 |   包头    | 长度 | 地址 | 命令 | 寄存器地址 | 数据 | 校验 |   包尾    |
+--------+-----------+------+------+------+------------+------+------+-----------+
|  长度  |     2     |  1   |  1   |  1   |     1      |  4   |  1   |     2     |
+--------+-----------+------+------+------+------------+------+------+-----------+
|  内容  | 0x7B 0x7B | len  | addr | cmd  | reg addr   | data | xor | 0x7D 0x7D |
+--------+-----------+------+------+------+------------+------+------+-----------+
```

### 3.2 字段说明

1. **包头 (Header)**

   - 固定值: `0x7B 0x7B`
   - 长度: 2字节
   - 用途: 标识数据包的开始
2. **长度 (Length)**

   - 长度: 1字节
   - 内容: 从长度字段到校验字段的总长度（不包括包头和包尾）
   - 固定值: 0x09
3. **地址 (Address)**

   - 长度: 1字节
   - 用途: 标识设备地址
   - 取值:

     - `0x81`: 脚洞控制盒1
     - `0x82`: 脚洞控制盒2
4. **命令 (Command)**

   - 长度: 1字节
   - 命令类型:
     - `0x03`: 总控向脚洞发送数据
     - `0x06`: 脚洞向总控发送数据
5. **寄存器地址 (Register Address)**

   - 长度: 1字节
   - 功能码:
     - `0x01`: 开门操作
     - `0x02`: 关门操作
     - `0x03`: 查询状态
6. **数据 (Data)**

   - 长度: 4字节
   - 状态码（总控向脚洞发送）:
     - 脚洞1开门指令: `00 00 00 A1`
     - 脚洞2开门指令: `00 00 00 A2`
     - 脚洞3开门指令: `00 00 00 A3`
     - 脚洞4开门指令: `00 00 00 A4`

     - 脚洞1关门指令: `00 00 00 C1`
     - 脚洞2关门指令: `00 00 00 C2`
     - 脚洞3关门指令: `00 00 00 C3`
     - 脚洞4关门指令: `00 00 00 C4`
     
     - 脚洞1查询指令: `00 00 00 D1`
     - 脚洞2查询指令: `00 00 00 D2`
     - 脚洞3查询指令: `00 00 00 D3`
     - 脚洞4查询指令: `00 00 00 D4`

   - 状态码（脚洞向总控发送）:

     - 脚洞1正在开门: `00 00 00 A1`
     - 脚洞2正在开门: `00 00 00 A2`
     - 脚洞3正在开门: `00 00 00 A3`
     - 脚洞4正在开门: `00 00 00 A4`
     
     - 脚洞1正在关门: `00 00 00 C1`
     - 脚洞2正在关门: `00 00 00 C2`
     - 脚洞3正在关门: `00 00 00 C3`
     - 脚洞4正在关门: `00 00 00 C4`

     - 脚洞1开门完成: `00 00 A1 00`
     - 脚洞2开门完成: `00 00 A2 00`
     - 脚洞3开门完成: `00 00 A3 00`
     - 脚洞4开门完成: `00 00 A4 00`

     - 脚洞1关门完成: `00 00 C1 00`
     - 脚洞2关门完成: `00 00 C2 00`
     - 脚洞3关门完成: `00 00 C3 00`
     - 脚洞4关门完成: `00 00 C4 00`

     - 脚洞1开门故障: `00 A1 00 00`
     - 脚洞2开门故障: `00 A2 00 00`
     - 脚洞3开门故障: `00 A3 00 00`
     - 脚洞4开门故障: `00 A4 00 00`

     - 脚洞1关门故障: `00 C1 00 00`
     - 脚洞2关门故障: `00 C2 00 00`
     - 脚洞3关门故障: `00 C3 00 00`
     - 脚洞4关门故障: `00 C4 00 00`
7. **校验 (XOR Checksum)**

   - 长度: 1字节
   - 计算方法: 从长度字段到数据字段的所有字节进行异或运算
8. **包尾 (Tail)**

   - 固定值: `0x7D 0x7D`
   - 长度: 2字节
   - 用途: 标识数据包的结束

## 4. 通信示例

### 4.1 总控向脚洞发送命令

- 包头: 7B 7B
- 长度: 09
- 地址: 81 (脚洞控制盒1)
- 命令: 03 (总控向脚洞发送) 06 (脚洞向总控发送)
- 寄存器: 01 (开门)  02 (关门) 03 (查询)
- 数据: 00 00 00 A1 (脚洞1开门) ......
- 校验: xx
- 包尾: 7D 7D

1. **开门命令**

```
7B 7B 09 81 03 01 00 00 00 A1 2B 7D 7D    # 发给控制盒1脚洞1开门
7B 7B 09 82 03 01 00 00 00 A1 28 7D 7D    # 发给控制盒2脚洞1开门

7B 7B 09 81 03 01 00 00 00 A2 28 7D 7D    # 发给控制盒1脚洞2开门
7B 7B 09 82 03 01 00 00 00 A2 2B 7D 7D    # 发给控制盒2脚洞2开门

......

```

2. **关门命令**

```
7B 7B 09 81 03 02 00 00 00 C1 48 7D 7D    # 发给控制盒1脚洞1关门
7B 7B 09 82 03 02 00 00 00 C1 4B 7D 7D    # 发给控制盒2脚洞1关门

7B 7B 09 81 03 02 00 00 00 C2 4B 7D 7D    # 发给控制盒1脚洞2关门
7B 7B 09 82 03 02 00 00 00 C2 48 7D 7D    # 发给控制盒2脚洞2关门

......

```

3. **查询命令**

```
7B 7B 09 81 03 03 00 00 00 D1 59 7D 7D    # 查询控制盒1脚洞1状态
7B 7B 09 82 03 03 00 00 00 D1 5A 7D 7D    # 查询控制盒2脚洞1状态

7B 7B 09 81 03 03 00 00 00 D2 5A 7D 7D    # 查询控制盒1脚洞2状态
7B 7B 09 82 03 03 00 00 00 D2 59 7D 7D    # 查询控制盒2脚洞2状态

......

```

### 4.2 脚洞向总控发送状态

1. **开门状态反馈**

```
控制盒1脚洞1正在开门：7B 7B 09 81 06 03 00 00 00 A1 2C 7D 7D
控制盒2脚洞1正在开门：7B 7B 09 82 06 03 00 00 00 A1 2F 7D 7D

控制盒1脚洞1开门完成：7B 7B 09 81 06 03 00 00 A1 00 2C 7D 7D
控制盒2脚洞1开门完成：7B 7B 09 82 06 03 00 00 A1 00 2F 7D 7D

控制盒1脚洞1开门故障：7B 7B 09 81 06 03 00 A1 00 00 2C 7D 7D
控制盒3脚洞1开门故障：7B 7B 09 82 06 03 00 A1 00 00 2F 7D 7D

......

```

2. **关门状态反馈**

```
控制盒1脚洞1正在关门：7B 7B 09 81 06 03 00 00 00 C1 XX 7D 7D
控制盒2脚洞1正在关门：7B 7B 09 82 06 03 00 00 00 C1 XX 7D 7D

控制盒1关门完成：7B 7B 09 81 06 03 00 00 C1 00 XX 7D 7D
控制盒2关门完成：7B 7B 09 82 06 03 00 00 C1 00 XX 7D 7D

控制盒1关门故障：7B 7B 09 81 06 03 00 C1 00 00 XX 7D 7D
控制盒2关门故障：7B 7B 09 82 06 03 00 C1 00 00 XX 7D 7D

```

## 5. 注意事项

1. **数据校验**

   - 使用异或（XOR）校验算法
   - 校验范围：从长度字段到数据字段
   - 校验计算方法：对所有字节进行异或运算
   - 波特率：9600bps
   
   
   


